<?php/** * Funciones de NotificaciÃ³n GHL * Email y Tareas para usuarios asignados */// ConfiguraciÃ³n GHL (si no estÃ¡n definidas)if (!defined('GHL_API_BASE')) {    define('GHL_API_BASE', 'https://services.leadconnectorhq.com');}if (!defined('GHL_API_KEY')) {    define('GHL_API_KEY', 'pit-2c52c956-5347-4a29-99a8-723a0e2d4afd');}if (!defined('GHL_API_VERSION')) {    define('GHL_API_VERSION', '2021-07-28');}if (!defined('GHL_LOCATION_ID')) {    define('GHL_LOCATION_ID', 'sBhcSc6UurgGMeTV10TC');}// Log file path - absolute path for Windowsdefine('NOTIFICATION_LOG', 'C:\\laragon\\www\\Ticketing System\\logs\\notifications.log');// Test de inclusiÃ³n - escribir a un archivo diferentefile_put_contents('C:\\Users\\Skar\\Desktop\\Ticketing System\\logs\\ghl_notif_included.txt', date('Y-m-d H:i:s') . " - ghl-notifications.php was loaded\n", FILE_APPEND);// Log de inclusiÃ³nfile_put_contents(NOTIFICATION_LOG, date('Y-m-d H:i:s') . " - ghl-notifications.php included\n", FILE_APPEND);/** * Helper para log */function notifLog($message) {    file_put_contents(NOTIFICATION_LOG, date('Y-m-d H:i:s') . " - $message\n", FILE_APPEND);}/** * Llamada a la API de GHL (versiÃ³n para notificaciones) */function ghlNotificationApiCall($endpoint, $method = 'GET', $data = null, $locationId = null) {    $url = GHL_API_BASE . $endpoint;        $headers = [        'Authorization: Bearer ' . GHL_API_KEY,        'Version: ' . GHL_API_VERSION,        'Content-Type: application/json',        'Accept: application/json'    ];        if ($locationId) {        $headers[] = 'Location: ' . $locationId;    }        $ch = curl_init();    curl_setopt($ch, CURLOPT_URL, $url);    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);    curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);    curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, true);    curl_setopt($ch, CURLOPT_TIMEOUT, 30);        if ($method === 'POST') {        curl_setopt($ch, CURLOPT_POST, true);        if ($data) {            curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($data));        }    }        $response = curl_exec($ch);    $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);    $error = curl_error($ch);    curl_close($ch);        notifLog("API Call: $method $endpoint - HTTP $httpCode");        if ($error) {        notifLog("CURL Error: $error");        return ['error' => $error, 'httpCode' => $httpCode];    }        $decoded = json_decode($response, true);    if (!$decoded) {        notifLog("Response decode failed: " . substr($response, 0, 200));    }        return $decoded ?: ['error' => 'Invalid response', 'httpCode' => $httpCode];}/** * Enviar notificaciÃ³n por email al usuario asignado */function sendEmailNotification($pdo, $userId, $ticketData) {    notifLog("=== INICIO sendEmailNotification userId: $userId ===");        $stmt = $pdo->prepare("SELECT * FROM users WHERE id = ?");    $stmt->execute([$userId]);    $user = $stmt->fetch();        if (!$user || empty($user['email'])) {        notifLog("ERROR: Usuario $userId no encontrado o sin email");        return ['success' => false, 'error' => 'Usuario no encontrado o sin email'];    }        notifLog("Usuario: {$user['name']} ({$user['email']})");        // Buscar o crear contacto en GHL    $contactId = findOrCreateContact($user['email'], $user['name']);        if (!$contactId) {        return ['success' => false, 'error' => 'No se pudo obtener/crear contacto en GHL'];    }        // Enviar email    notifLog("Enviando email...");    $emailData = [        'type' => 'Email',        'contactId' => $contactId,        'subject' => 'Nuevo Ticket Asignado: ' . $ticketData['ticket_number'],        'html' => buildEmailTemplate($ticketData, $user)    ];        $result = ghlNotificationApiCall('/conversations/messages', 'POST', $emailData, GHL_LOCATION_ID);    notifLog("Resultado email: " . json_encode($result));        return [        'success' => !isset($result['error']),        'type' => 'email',        'result' => $result    ];}/** * Buscar o crear contacto en GHL */function findOrCreateContact($email, $name) {    notifLog("Buscando/creando contacto para: $email");        // Primero intentar buscar por email usando search    $searchResult = ghlNotificationApiCall('/contacts/search/duplicate?locationId=' . GHL_LOCATION_ID . '&email=' . urlencode($email), 'GET', null, GHL_LOCATION_ID);    notifLog("Busqueda duplicado: " . json_encode($searchResult));        if (!empty($searchResult['contact']['id'])) {        notifLog("Contacto encontrado via search: " . $searchResult['contact']['id']);        return $searchResult['contact']['id'];    }        // Si no existe, crearlo    notifLog("Creando nuevo contacto...");    $createResult = ghlNotificationApiCall('/contacts/', 'POST', [        'email' => $email,        'name' => $name,        'locationId' => GHL_LOCATION_ID    ], GHL_LOCATION_ID);        notifLog("Resultado crear: " . json_encode($createResult));        // Si ya existe (duplicado), extraer el ID del error    if (!empty($createResult['meta']['contactId'])) {        notifLog("Contacto ya existia, usando ID: " . $createResult['meta']['contactId']);        return $createResult['meta']['contactId'];    }        if (!empty($createResult['contact']['id'])) {        notifLog("Contacto creado: " . $createResult['contact']['id']);        return $createResult['contact']['id'];    }        notifLog("ERROR: No se pudo obtener contactId");    return null;}/** * Crear tarea en GHL para el usuario asignado */function createGHLTask($pdo, $userId, $ticketData) {    notifLog("=== INICIO createGHLTask userId: $userId ===");        $stmt = $pdo->prepare("SELECT * FROM users WHERE id = ?");    $stmt->execute([$userId]);    $user = $stmt->fetch();        if (!$user) {        notifLog("ERROR: Usuario no encontrado");        return ['success' => false, 'error' => 'Usuario no encontrado'];    }        notifLog("Usuario: {$user['name']}");        // Buscar o crear contacto    $contactId = findOrCreateContact($user['email'], $user['name']);        if (!$contactId) {        notifLog("ERROR: No se pudo obtener/crear contacto para tarea");        return ['success' => false, 'error' => 'No se pudo obtener/crear contacto en GHL'];    }        notifLog("Creando tarea para contacto: $contactId");        $dueDate = !empty($ticketData['due_date'])         ? $ticketData['due_date']         : date('Y-m-d', strtotime('+3 days'));        $priorityMap = [        'urgent' => 'URGENTE',        'high' => 'Alta',        'medium' => 'Media',        'low' => 'Baja'    ];    $priorityLabel = $priorityMap[$ticketData['priority'] ?? 'medium'] ?? 'Media';        $taskData = [        'title' => "Ticket {$ticketData['ticket_number']}: {$ticketData['title']}",        'body' => "Ticket Asignado\n\nNumero: {$ticketData['ticket_number']}\nPrioridad: {$priorityLabel}\nDescripcion:\n{$ticketData['description']}",        'dueDate' => $dueDate . 'T12:00:00Z',        'completed' => false,        'assignedTo' => $user['ghl_user_id'] ?? null    ];        $result = ghlNotificationApiCall("/contacts/{$contactId}/tasks", 'POST', $taskData, GHL_LOCATION_ID);    notifLog("Resultado tarea: " . json_encode($result));        return [        'success' => !isset($result['error']),        'type' => 'task',        'result' => $result    ];}/** * Template de email HTML */function buildEmailTemplate($ticketData, $user) {    $priorityColors = [        'urgent' => '#dc3545',        'high' => '#fd7e14',        'medium' => '#ffc107',        'low' => '#28a745'    ];    $priorityLabels = [        'urgent' => 'URGENTE',        'high' => 'Alta',        'medium' => 'Media',        'low' => 'Baja'    ];        $priority = $ticketData['priority'] ?? 'medium';    $priorityColor = $priorityColors[$priority] ?? '#ffc107';    $priorityLabel = $priorityLabels[$priority] ?? 'Media';        $dueDate = !empty($ticketData['due_date'])         ? date('d/m/Y', strtotime($ticketData['due_date']))        : 'No especificada';        $description = nl2br(htmlspecialchars($ticketData['description'] ?? ''));        return "    <html>    <body style='font-family: Arial, sans-serif; line-height: 1.6; color: #333;'>        <div style='max-width: 600px; margin: 0 auto; padding: 20px;'>            <div style='background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 10px 10px 0 0;'>                <h1 style='margin:0;'>Nuevo Ticket Asignado</h1>            </div>            <div style='background: #f8f9fa; padding: 30px; border: 1px solid #e9ecef;'>                <p>Hola <strong>{$user['name']}</strong>,</p>                <p>Se te ha asignado un nuevo ticket:</p>                                <div style='background: white; border-radius: 8px; padding: 20px; margin: 15px 0;'>                    <h2 style='margin-top:0; color: #333;'>{$ticketData['title']}</h2>                    <p><strong>Numero:</strong> {$ticketData['ticket_number']}</p>                    <p><strong>Prioridad:</strong> <span style='background:{$priorityColor}; color:white; padding: 3px 10px; border-radius: 10px;'>{$priorityLabel}</span></p>                    <p><strong>Fecha limite:</strong> {$dueDate}</p>                    <hr style='border: none; border-top: 1px solid #eee;'>                    <p><strong>Descripcion:</strong></p>                    <p style='background: #f8f9fa; padding: 15px; border-radius: 5px;'>{$description}</p>                </div>            </div>            <div style='text-align: center; padding: 20px; color: #6c757d; font-size: 12px;'>                <p>Sistema de Ticketing - Mensaje automatico</p>            </div>        </div>    </body>    </html>";}/** * Funcion principal para notificar asignacion */function notifyTicketAssignment($pdo, $userId, $ticketData) {    notifLog("========================================");    notifLog("NOTIFICACION DE TICKET ASIGNADO");    notifLog("Ticket: " . ($ticketData['ticket_number'] ?? 'N/A'));    notifLog("Usuario destino: $userId");    notifLog("========================================");        $results = [];        // Enviar email    $results['email'] = sendEmailNotification($pdo, $userId, $ticketData);        // Crear tarea en GHL    $results['task'] = createGHLTask($pdo, $userId, $ticketData);        notifLog("RESULTADO FINAL: " . json_encode($results));    notifLog("========================================\n");        return $results;}/** * Actualizar custom fields de un contacto en GHL */function updateContactCustomFields($contactId, $customFields) {    $data = [        'customField' => $customFields    ];        require_once __DIR__ . '/ghl.php';        $result = ghlApiCall("/contacts/{$contactId}", 'PUT', $data, GHL_LOCATION_ID);        notifLog("Actualizar custom fields para contacto {$contactId}: " . json_encode($result));        return [        'success' => !isset($result['error']),        'result' => $result    ];}/** * Generar link de seguimiento del ticket */function generateTrackingLink($ticketId, $ticketNumber, $pdo = null) {    // Generar token    $token = hash('sha256', $ticketId . $ticketNumber . time());        // Guardar token en BD    if ($pdo) {        try {            $stmt = $pdo->prepare("                INSERT INTO ticket_tracking_tokens (ticket_id, token, created_at)                 VALUES (?, ?, NOW())                ON DUPLICATE KEY UPDATE token = VALUES(token), created_at = NOW()            ");            $stmt->execute([$ticketId, $token]);        } catch (Exception $e) {            notifLog("Error guardando token: " . $e->getMessage());        }    }        // URL del cliente    $baseUrl = (isset($_SERVER['HTTPS']) && $_SERVER['HTTPS'] === 'on' ? 'https' : 'http') .                '://' . $_SERVER['HTTP_HOST'];        return $baseUrl . '/ticket-tracking.php?id=' . $ticketNumber . '&token=' . substr($token, 0, 20);}/** * Enviar mensaje WhatsApp directo */function sendWhatsAppMessage($pdo, $contactId, $contactPhone, $messageText) {    require_once __DIR__ . '/ghl.php';        $messageData = [        'type' => 'WhatsApp',        'contactId' => $contactId,        'message' => $messageText,        'status' => 'pending'    ];        $result = ghlApiCall('/conversations/messages', 'POST', $messageData, GHL_LOCATION_ID);        notifLog("WhatsApp enviado a {$contactPhone}: " . $messageText);        return [        'success' => !isset($result['error']),        'contactId' => $contactId,        'result' => $result    ];}/** * Enviar WhatsApp usando template */function sendWhatsAppTemplate($pdo, $contactPhone, $templateName, $variables = []) {    require_once __DIR__ . '/ghl.php';        // Buscar contacto - usar endpoint correcto con query parameter    $searchResult = ghlApiCall('/contacts/?locationId=' . GHL_LOCATION_ID . '&query=' . urlencode($contactPhone), 'GET', null, GHL_LOCATION_ID);        $contactId = null;    if (!empty($searchResult['contacts'][0]['id'])) {        $contactId = $searchResult['contacts'][0]['id'];    } else {        $createResult = ghlApiCall('/contacts/', 'POST', [            'phone' => $contactPhone,            'locationId' => GHL_LOCATION_ID        ], GHL_LOCATION_ID);                if (!empty($createResult['contact']['id'])) {            $contactId = $createResult['contact']['id'];        }    }        if (!$contactId) {        notifLog("Error: No se pudo obtener/crear contacto para {$contactPhone}");        return ['success' => false, 'error' => 'No se pudo obtener/crear contacto en GHL'];    }        // Enviar WhatsApp    $messageData = [        'type' => 'WhatsApp',        'contactId' => $contactId,        'message' => "Tu ticket " . ($variables['ticket_id'] ?? 'N/A') . " ha sido creado. Puedes consultarlo en: " . ($variables['link_seguimiento'] ?? '#'),        'status' => 'pending'    ];        $result = ghlApiCall('/conversations/messages', 'POST', $messageData, GHL_LOCATION_ID);        notifLog("WhatsApp enviado a {$contactPhone} con template {$templateName}: " . json_encode($result));        return [        'success' => !isset($result['error']),        'contactId' => $contactId,        'result' => $result    ];}/** * Notificar ticket creado */function notifyTicketCreatedWA($pdo, $ticketData) {    try {        notifLog("=== INICIANDO notifyTicketCreatedWA ===");                if (empty($ticketData['contact_phone'])) {            notifLog("Error: Sin telÃ©fono en ticketData");            return ['success' => false, 'error' => 'Sin telÃ©fono'];        }                notifLog("INICIANDO: Notificar ticket creado - {$ticketData['ticket_number']} - TelÃ©fono: {$ticketData['contact_phone']}");                // Generar link        $trackingLink = generateTrackingLink($ticketData['id'], $ticketData['ticket_number'], $pdo);                notifLog("Tracking link generado: " . $trackingLink);                // Buscar o crear contacto usando ghlNotificationApiCall        $searchResult = ghlNotificationApiCall('/contacts/?locationId=' . GHL_LOCATION_ID . '&query=' . urlencode($ticketData['contact_phone']), 'GET', null, GHL_LOCATION_ID);                notifLog("Resultado bÃºsqueda: " . json_encode($searchResult));                $contactId = null;        if (!empty($searchResult['contacts'][0]['id'])) {            $contactId = $searchResult['contacts'][0]['id'];            notifLog("Contacto encontrado: $contactId");        } else {            notifLog("Contacto no encontrado, creando nuevo...");            $createResult = ghlNotificationApiCall('/contacts/', 'POST', [                'phone' => $ticketData['contact_phone'],                'name' => $ticketData['contact_name'] ?? 'Cliente',                'email' => $ticketData['contact_email'] ?? null,                'locationId' => GHL_LOCATION_ID            ], GHL_LOCATION_ID);                        notifLog("Contacto create result: " . json_encode($createResult));                        // Verificar diferentes estructuras de respuesta            if (!empty($createResult['contact']['id'])) {                $contactId = $createResult['contact']['id'];                notifLog("Contacto creado (estructura 1): $contactId");            } elseif (!empty($createResult['meta']['contactId'])) {                $contactId = $createResult['meta']['contactId'];                notifLog("Contacto creado (estructura 2): $contactId");            } else {                notifLog("ERROR: Respuesta de create no tiene contactId: " . json_encode($createResult));            }        }                if (!$contactId) {            notifLog("Error: No se pudo crear contacto para {$ticketData['contact_phone']}");            return ['success' => false, 'error' => 'No se pudo crear contacto'];        }                // Actualizar custom fields        $customFields = [            'ticket_id' => $ticketData['ticket_number'],            'link_seguimiento' => $trackingLink        ];                notifLog("Actualizando custom fields...");        updateContactCustomFields($contactId, $customFields);                // Enviar WhatsApp con mensaje personalizado        $messageText = "Â¡Hola! Tu ticket " . $ticketData['ticket_number'] . " ha sido creado exitosamente. Puedes consultarlo en: " . $trackingLink;        notifLog("Enviando WhatsApp: " . $messageText);        $result = sendWhatsAppMessage($pdo, $contactId, $ticketData['contact_phone'], $messageText);                notifLog("FIN: Notificar ticket creado - Result: " . json_encode($result));                return [            'success' => $result['success'],            'contactId' => $contactId,            'trackingLink' => $trackingLink        ];    } catch (Exception $e) {        notifLog("EXCEPCIÃ“N en notifyTicketCreatedWA: " . $e->getMessage() . " - LÃ­nea: " . $e->getLine());        return ['success' => false, 'error' => $e->getMessage()];    }}/** * Notificar informaciÃ³n pendiente */function notifyInfoPendingWA($pdo, $ticketId, $contactPhone, $contactName, $pendingInfo) {    if (empty($contactPhone)) {        return ['success' => false, 'error' => 'Sin telÃ©fono'];    }        notifLog("INICIANDO: Notificar informaciÃ³n pendiente - ID {$ticketId}");        // Obtener ticket    $stmt = $pdo->prepare("SELECT id, ticket_number FROM tickets WHERE id = ?");    $stmt->execute([$ticketId]);    $ticket = $stmt->fetch();        if (!$ticket) {        return ['success' => false, 'error' => 'Ticket no encontrado'];    }        $trackingLink = generateTrackingLink($ticketId, $ticket['ticket_number'], $pdo);        // Actualizar custom fields    $customFields = [        'ticket_id' => $ticket['ticket_number'],        'informacion_pendiente' => $pendingInfo,        'link_seguimiento' => $trackingLink    ];        // Buscar contacto    require_once __DIR__ . '/ghl.php';    $searchResult = ghlApiCall('/contacts/?locationId=' . GHL_LOCATION_ID . '&query=' . urlencode($contactPhone), 'GET', null, GHL_LOCATION_ID);        $contactId = $searchResult['contacts'][0]['id'] ?? null;        if ($contactId) {        updateContactCustomFields($contactId, $customFields);        // Enviar WhatsApp con mensaje personalizado        $messageText = "Hola, necesitamos la siguiente informaciÃ³n para tu ticket " . $ticket['ticket_number'] . ": " . $pendingInfo . ". Responde en este chat o consulta: " . $trackingLink;        $result = sendWhatsAppMessage($pdo, $contactId, $contactPhone, $messageText);    } else {        return ['success' => false, 'error' => 'Contacto no encontrado'];    }        notifLog("FIN: Notificar informaciÃ³n pendiente");        return ['success' => $result['success']];}/** * Notificar inicio de desarrollo */function notifyDevelopmentStartedWA($pdo, $ticketId, $contactPhone) {    if (empty($contactPhone)) {        return ['success' => false, 'error' => 'Sin telÃ©fono'];    }        notifLog("INICIANDO: Notificar desarrollo iniciado - ID {$ticketId}");        // Obtener ticket    $stmt = $pdo->prepare("SELECT id, ticket_number FROM tickets WHERE id = ?");    $stmt->execute([$ticketId]);    $ticket = $stmt->fetch();        if (!$ticket) {        return ['success' => false, 'error' => 'Ticket no encontrado'];    }        $trackingLink = generateTrackingLink($ticketId, $ticket['ticket_number'], $pdo);        // Actualizar custom fields    $customFields = [        'ticket_id' => $ticket['ticket_number'],        'link_seguimiento' => $trackingLink    ];        // Buscar contacto    require_once __DIR__ . '/ghl.php';    $searchResult = ghlApiCall('/contacts/?locationId=' . GHL_LOCATION_ID . '&query=' . urlencode($contactPhone), 'GET', null, GHL_LOCATION_ID);        $contactId = $searchResult['contacts'][0]['id'] ?? null;        if ($contactId) {        updateContactCustomFields($contactId, $customFields);        // Enviar WhatsApp con mensaje personalizado        $messageText = "Â¡Excelente noticia! El desarrollo de tu ticket " . $ticket['ticket_number'] . " ha iniciado. Puedes ver el progreso en: " . $trackingLink;        $result = sendWhatsAppMessage($pdo, $contactId, $contactPhone, $messageText);    } else {        return ['success' => false, 'error' => 'Contacto no encontrado'];    }        notifLog("FIN: Notificar desarrollo iniciado");        return ['success' => $result['success']];/** * Notificar cuando información está pendiente */function notifyPendingInfo($pdo, $ticketData) {    $contactPhone = $ticketData['contact_phone'] ?? null;    $ticketNumber = $ticketData['ticket_number'] ?? 'UNKNOWN';        if (!$contactPhone) {        notifLog("notifyPendingInfo: No hay teléfono de contacto para ticket $ticketNumber");        return ['success' => false, 'error' => 'No contact phone'];    }        notifLog("=== INICIANDO notifyPendingInfo ===");    notifLog("INICIANDO: Información pendiente - $ticketNumber - Teléfono: $contactPhone");        // Enviar WhatsApp con template copy_info_pendiente2    $variables = [        'ticket_number' => $ticketNumber,        'ticket_id' => $ticketData['id'] ?? ''    ];        return sendWhatsAppTemplate($pdo, $contactPhone, 'copy_info_pendiente2', $variables);}/** * Notificar cuando ticket está en proceso */function notifyInProgress($pdo, $ticketData) {    $contactPhone = $ticketData['contact_phone'] ?? null;    $ticketNumber = $ticketData['ticket_number'] ?? 'UNKNOWN';        if (!$contactPhone) {        notifLog("notifyInProgress: No hay teléfono de contacto para ticket $ticketNumber");        return ['success' => false, 'error' => 'No contact phone'];    }        notifLog("=== INICIANDO notifyInProgress ===");    notifLog("INICIANDO: Ticket en proceso - $ticketNumber - Teléfono: $contactPhone");        // Enviar WhatsApp con template en_desarrollo    $variables = [        'ticket_number' => $ticketNumber,        'ticket_id' => $ticketData['id'] ?? ''    ];        return sendWhatsAppTemplate($pdo, $contactPhone, 'en_desarrollo', $variables);}}